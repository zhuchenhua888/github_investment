# 数据接口工具使用说明

## 一、环境要求

### 1. 系统要求
- Windows 10/11 或 macOS 10.15+ 或 Linux (Ubuntu 18.04+, CentOS 7+)
- Python 3.8 及以上版本

### 2. 依赖库
- akshare >= 1.17.0
- baostock >= 0.8.8
- pandas >= 1.3.0
- matplotlib >= 3.5.0
- mplfinance >= 0.12.8b9
- pyyaml >= 6.0
- numpy >= 1.21.0

## 二、安装步骤

### 1. 安装Python
访问 [Python官网](https://www.python.org/downloads/) 下载并安装Python 3.8+，安装时勾选"Add Python to PATH"选项。

### 2. 安装依赖库
打开命令行终端，执行以下命令安装所需依赖：

```bash
pip install akshare baostock pandas matplotlib mplfinance pyyaml numpy
```

### 3. 获取代码
将提供的Python代码保存为`data_interface_tool.py`文件。

## 三、配置文件说明

### 1. 配置文件结构
工具使用YAML格式的配置文件，定义需要调用的接口、参数、数据字段和图表设置。配置文件基本结构如下：

```yaml
interfaces:
  - name: 接口名称
    type: 接口类型 (akshare/baostock)
    function: 接口函数名
    params: 接口调用参数
    fields: 需要提取的字段列表
    storage: 数据存储配置
    chart: 图表展示配置
```

### 2. 配置项说明

#### 2.1 基本配置
- `name`: 接口名称，用于标识接口和生成文件名
- `type`: 接口类型，目前支持`akshare`和`baostock`
- `function`: 接口函数名，需与数据源提供的函数名一致
- `params`: 接口调用参数，字典格式，根据不同接口要求设置

#### 2.2 数据字段配置
- `fields`: 需要从接口返回结果中提取的字段列表，如`["数据日期", "市价总值-上海"]`

#### 2.3 存储配置
```yaml
storage:
  format: 存储格式 (csv/excel)，默认csv
  path: 存储路径，默认./data/
```

#### 2.4 图表配置
```yaml
chart:
  type: 图表类型 (line/candle)，折线图或K线图
  title: 图表标题
  x: X轴字段名
  x_label: X轴标签
  y: Y轴字段名或字段列表 (单Y轴多数据)
  y_label: Y轴标签
  left_y: 左侧Y轴数据系列 (双Y轴配置)
  right_y: 右侧Y轴数据系列 (双Y轴配置)
```

### 3. 配置示例

#### 3.1 股票市值数据配置 (akshare)
```yaml
interfaces:
  - name: 股票市值数据
    type: akshare
    function: macro_china_stock_market_cap
    params: {}
    fields: ["数据日期", "市价总值-上海", "市价总值-深圳"]
    storage:
      format: csv
      path: ./data/
    chart:
      type: line
      title: 沪深股市市值趋势图
      x: 数据日期
      x_label: 日期
      y: ["市价总值-上海", "市价总值-深圳"]
      y_label: 市值(亿元)
```

#### 3.2 股票历史K线配置 (baostock)
```yaml
interfaces:
  - name: 股票历史K线
    type: baostock
    function: query_history_k_data_plus
    params:
      code: sh.600000
      start_date: 2023-01-01
      end_date: 2023-12-31
      frequency: d
      adjustflag: 3
      fields: date,open,high,low,close,volume
    fields: ["date", "open", "high", "low", "close", "volume"]
    storage:
      format: csv
      path: ./data/
    chart:
      type: candle
      title: 股票历史K线图
      y_label: 价格(元)
```

## 四、运行方法

### 1. 创建配置文件
根据上述配置说明，创建配置文件`config.yaml`，定义需要调用的接口。

### 2. 基本运行方式
在命令行终端中，执行以下命令运行工具：

```bash
python data_interface_tool.py config.yaml
```

如果未指定配置文件路径，工具将默认查找当前目录下的`接口配置文件模板.yaml`：

```bash
python data_interface_tool.py
```

### 3. 命令行参数
- `config_path`: 配置文件路径，可选参数，默认为`接口配置文件模板.yaml`

## 五、输出说明

### 1. 数据文件
工具将获取的数据保存到指定路径，默认路径为`./data/`目录下，文件名为接口名称+.csv（或.xlsx），如`股票市值数据.csv`。

### 2. 图表文件
生成的图表保存到`./data/charts/`目录下，文件名为接口名称+_chart.png，如`股票市值数据_chart.png`。

### 3. 日志输出
工具运行过程中会输出日志信息，包括接口调用状态、数据处理进度、错误信息等，帮助用户了解运行情况和排查问题。

## 六、常见问题

### 1. 中文显示乱码
**问题**：图表中的中文标签显示为方框或乱码。  
**解决方法**：确保系统中已安装中文字体，或在代码中指定可用的中文字体：
```python
plt.rcParams["font.family"] = ["SimHei", "WenQuanYi Micro Hei", "Heiti TC"]
```

### 2. 接口调用失败
**问题**：接口调用失败，提示"函数不存在"或"参数错误"。  
**解决方法**：
- 检查接口类型(`type`)是否正确
- 确认接口函数名(`function`)与数据源提供的一致
- 检查参数(`params`)是否符合接口要求，参考数据源官方文档

### 3. 字段不匹配
**问题**：提示"配置中的字段与接口返回数据不匹配"。  
**解决方法**：
- 查看日志中的"接口返回的字段"信息，获取实际返回的字段名
- 修改配置文件中的`fields`，使用实际返回的字段名

### 4. 图表生成失败
**问题**：数据获取成功，但图表生成失败或为空。  
**解决方法**：
- 检查数据是否为空或包含无效值
- 确认图表配置中的`x`和`y`字段是否存在于数据中
- 检查图表类型与数据是否匹配（如K线图需要特定字段）

### 5. 依赖库安装失败
**问题**：安装依赖库时提示安装失败。  
**解决方法**：
- 更新pip工具：`pip install --upgrade pip`
- 单独安装失败的库：`pip install 库名 --upgrade`
- 对于Windows系统，可能需要安装[Microsoft Visual C++ Redistributable](https://support.microsoft.com/zh-cn/help/2977003/the-latest-supported-visual-c-downloads)

## 七、示例配置与运行结果

### 1. 完整配置示例
```yaml
interfaces:
  - name: 股票市值数据
    type: akshare
    function: macro_china_stock_market_cap
    params: {}
    fields: ["数据日期", "市价总值-上海", "市价总值-深圳"]
    storage:
      format: csv
      path: ./data/
    chart:
      type: line
      title: 沪深股市总市值趋势图
      x: 数据日期
      x_label: 日期
      y: ["市价总值-上海", "市价总值-深圳"]
      y_label: 总市值(亿元)
  
  - name: 股票历史K线
    type: baostock
    function: query_history_k_data_plus
    params:
      code: sh.600000
      start_date: 2023-01-01
      end_date: 2023-12-31
      frequency: d
      adjustflag: 3
      fields: date,open,high,low,close,volume
    fields: ["date", "open", "high", "low", "close", "volume"]
    storage:
      format: csv
      path: ./data/
    chart:
      type: candle
      title: 股票历史K线图
      y_label: 价格(元)
```

### 2. 运行结果示例
执行命令后，将在`./data/`目录下生成：
- `股票市值数据.csv`
- `股票历史K线.csv`

在`./data/charts/`目录下生成：
- `股票市值数据_chart.png` (折线图)
- `股票历史K线_chart.png` (K线图)