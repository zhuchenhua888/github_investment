<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>抢权配债进度日更</title>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f7f7f9;color:#222}
    header{display:flex;align-items:center;gap:12px;padding:16px 20px;background:#fff;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:10}
    h1{font-size:18px;margin:0 8px 0 0}
    .spacer{flex:1}
    button{border:1px solid #d1d5db;background:#fff;color:#111;padding:8px 12px;border-radius:8px;cursor:pointer}
    button:hover{background:#f3f4f6}
    button:disabled{opacity:.6;cursor:not-allowed}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid #d1d5db;background:#fff}
    main{padding:0}
    table{width:100%;border-collapse:collapse;background:#fff;border-left:none;border-right:none}
    thead th{position:sticky;top:64px;background:#fff;z-index:5}
    th,td{border-bottom:1px solid #e5e7eb;padding:6px 8px;text-align:left;vertical-align:top;font-size:13px}
    tbody tr:hover{background:#fafafa}
    .small{font-size:12px;color:#666}
    .status-ok{color:#059669}
    .status-warn{color:#b45309}
    .rowcount{color:#374151}
    .controls{display:flex;gap:10px;align-items:center}
    .toggle{display:inline-flex;align-items:center;gap:8px}
    .settings-btn{background:none;border:none;cursor:pointer;font-size:16px;padding:4px}
    .settings-btn:hover{background:#eee;border-radius:4px}
    
    /* Table Enhancements */
    th { cursor: pointer; user-select: none; white-space: nowrap; position: relative; }
    th:hover { background: #f3f4f6; }
    .th-content { display: flex; align-items: center; justify-content: space-between; gap: 4px; }
    .filter-row { margin-top: 4px; }
    .filter-input { width: 100%; box-sizing: border-box; font-size: 12px; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px; font-weight: normal; }
    .sort-icon { font-size: 10px; color: #9ca3af; display: flex; flex-direction: column; line-height: 0.8; }
    .sort-asc .sort-icon .up { color: #111; }
    .sort-desc .sort-icon .down { color: #111; }
    
    /* Settings Dialog */
    dialog { border: none; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); padding: 0; max-width: 500px; width: 90%; }
    dialog::backdrop { background: rgba(0,0,0,0.5); }
    .dialog-header { padding: 16px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
    .dialog-header h3 { margin: 0; font-size: 18px; }
    .dialog-body { padding: 16px; max-height: 60vh; overflow-y: auto; }
    .dialog-footer { padding: 16px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 8px; }
    .col-settings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
    .col-option { display: flex; align-items: center; gap: 6px; font-size: 14px; cursor: pointer; }
    
    /* Edit Dialog */
    .edit-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-group label { font-size: 12px; color: #666; }
    .form-group input { padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; }
    .full-width { grid-column: 1 / -1; }
    
    .footer{padding:12px 20px;color:#666;display:flex;justify-content:space-between;align-items:center}
    .pagination { display: flex; gap: 8px; align-items: center; }
    .page-btn { padding: 4px 8px; border: 1px solid #d1d5db; background: #fff; cursor: pointer; border-radius: 4px; }
    .page-btn:disabled { opacity: 0.5; cursor: default; }
    .page-info { font-size: 13px; color: #555; }
  </style>
</head>
<body>
  <header>
    <h1>抢权配债进度日更</h1>
    <div class="controls">
      <button id="updateBtn">手动更新</button>
      <button id="exportBtn">导出 .db</button>
      <button id="exportExcelBtn">导出 Excel</button>
      <button id="settingsBtn" class="settings-btn" title="表格设置">⚙️</button>
      <label class="toggle pill"><input type="checkbox" id="autoToggle"> 自动每日更新</label>
    </div>
    <div class="spacer"></div>
    <div class="pill" id="status" style="margin-right:8px; border:none; background:none; padding:6px 0; font-weight:500">准备就绪</div>
    <div class="pill" id="rowCount" style="margin-right:8px">0 条记录</div>
    <div class="pill" id="lastUpdate">最后更新：—</div>
  </header>
  <main>
    <table id="dataTable">
      <thead>
        <tr>
          <th>可转债代码</th>
          <th>可转债名称</th>
          <th>股票代码</th>
          <th>股票名称</th>
          <th>发行规模（亿元）</th>
          <th>信用评级</th>
          <th>当前方案进展时间</th>
          <th>当前方案进展</th>
          <th>董事会预案</th>
          <th>股东大会批准</th>
          <th>交易所受理</th>
          <th>上市委通过</th>
          <th>同意注册</th>
          <th>申购时间</th>
          <th>申购代码</th>
          <th>上市日期</th>
          <th>到期日期</th>
          <th>退市日期</th>
          <th>退市原因</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="footer">
      <div class="small">来源：`https://www.jisilu.cn/data/cbnew/pre_list/`</div>
      <div class="pagination" id="pagination">
        <span class="page-info" id="pageInfo"></span>
        <button class="page-btn" id="prevPageBtn">上一页</button>
        <button class="page-btn" id="nextPageBtn">下一页</button>
        <select id="pageSizeSelect" style="margin-left:8px;padding:4px">
           <option value="50">50条/页</option>
           <option value="100" selected>100条/页</option>
           <option value="200">200条/页</option>
           <option value="500">500条/页</option>
           <option value="10000">全部</option>
        </select>
      </div>
    </div>
    
    <dialog id="settingsDialog">
      <div class="dialog-header">
        <h3>显示列设置</h3>
        <button onclick="document.getElementById('settingsDialog').close()" style="border:none;background:none;font-size:18px;cursor:pointer">✕</button>
      </div>
      <div class="dialog-body">
        <div id="colSettings" class="col-settings-grid"></div>
      </div>
      <div class="dialog-footer">
        <button onclick="document.getElementById('settingsDialog').close()">取消</button>
        <button id="saveSettingsBtn" style="background:#2563eb;color:#fff;border-color:#2563eb">保存</button>
      </div>
    </dialog>
    
    <dialog id="editDialog">
      <div class="dialog-header">
        <h3>编辑数据</h3>
        <button onclick="document.getElementById('editDialog').close()" style="border:none;background:none;font-size:18px;cursor:pointer">✕</button>
      </div>
      <div class="dialog-body">
        <form id="editForm" class="edit-form-grid"></form>
      </div>
      <div class="dialog-footer">
        <button onclick="document.getElementById('editDialog').close()">取消</button>
        <button id="saveEditBtn" style="background:#2563eb;color:#fff;border-color:#2563eb">保存</button>
      </div>
    </dialog>
  </main>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.9.0/sql-wasm.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const API_URL = 'https://www.jisilu.cn/data/cbnew/pre_list/';
    const DB_FILE = 'cb_data.db';
    const SERVER_DB_PATH = 'cb_data.db';
    const SERVER_UPDATE_URL = '/update';
    
    const COLUMNS = [
      { key: 'bond_id', label: '可转债代码' },
      { key: 'bond_nm', label: '可转债名称' },
      { key: 'stock_id', label: '股票代码' },
      { key: 'stock_nm', label: '股票名称' },
      { key: 'amount', label: '发行规模（亿元）', type: 'number' },
      { key: 'rating_cd', label: '信用评级' },
      { key: 'progress_dt', label: '当前方案进展时间' },
      { key: 'progress_nm', label: '当前方案进展' },
      { key: 'board_dt', label: '董事会预案' },
      { key: 'shareholder_dt', label: '股东大会批准' },
      { key: 'accept_dt', label: '交易所受理' },
      { key: 'committee_dt', label: '上市委通过' },
      { key: 'register_dt', label: '同意注册' },
      { key: 'apply_date', label: '申购时间' },
      { key: 'apply_cd', label: '申购代码' },
      { key: 'list_date', label: '上市日期' },
      { key: 'maturity_dt', label: '到期日期' },
      { key: 'delist_dt', label: '退市日期' },
      { key: 'delist_notes', label: '退市原因' }
    ];

    let appState = {
      sortCol: null,
      sortDir: 1, // 1 asc, -1 desc
      filters: {}, // key -> string
      visibleCols: COLUMNS.map(c => c.key),
      allRows: [],
      page: 1,
      pageSize: 100
    };

    let SQL;
    let db;
    let hasOPFS = false;
    let opfsRoot;
    let dbFileHandle;

    function todayStr(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const s = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${s}`;
    }

    function b64Encode(bytes){
      let bin = '';
      bytes.forEach(b=>bin += String.fromCharCode(b));
      return btoa(bin);
    }

    function b64Decode(str){
      const bin = atob(str);
      const arr = new Uint8Array(bin.length);
      for(let i=0;i<bin.length;i++) arr[i] = bin.charCodeAt(i);
      return arr;
    }

    function sanitizeProgressNm(s){
      if(!s) return '';
      return s.replace(/<br\s*\/?>/gi,' ').replace(/<[^>]+>/g,'');
    }

    function parseProgressFull(pf){
      const map = { board_dt:null, shareholder_dt:null, accept_dt:null, committee_dt:null, register_dt:null };
      if(!pf) return map;
      const lines = pf.split('\n').filter(Boolean);
      for(const line of lines){
        const m = line.match(/^(\d{4}-\d{2}-\d{2})\s+(.*)$/);
        if(!m) continue;
        const dt = m[1];
        const step = m[2].trim();
        if(step.includes('董事会预案')) map.board_dt = dt;
        else if(step.includes('股东大会通过')) map.shareholder_dt = dt;
        else if(step.includes('交易所受理')) map.accept_dt = dt;
        else if(step.includes('上市委通过')) map.committee_dt = dt;
        else if(step.includes('同意注册')) map.register_dt = dt;
      }
      return map;
    }

    async function initSQL(){
      SQL = await initSqlJs({ locateFile: f => 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.9.0/sql-wasm.wasm' });
    }

    async function initOPFS(){
      hasOPFS = !!(navigator.storage && navigator.storage.getDirectory);
      if(!hasOPFS) return;
      try {
        opfsRoot = await navigator.storage.getDirectory();
        dbFileHandle = await opfsRoot.getFileHandle(DB_FILE, { create: true });
      } catch(e) {
        hasOPFS = false;
        dbFileHandle = null;
      }
    }

    async function loadDB(){
      if(hasOPFS && dbFileHandle){
        try{
          const file = await dbFileHandle.getFile();
          const buf = await file.arrayBuffer();
          if(buf.byteLength>0){
            db = new SQL.Database(new Uint8Array(buf));
          } else {
            db = new SQL.Database();
          }
        }catch(e){
          db = new SQL.Database();
        }
      } else {
        const b64 = localStorage.getItem('cb_db');
        if(b64){
          db = new SQL.Database(b64Decode(b64));
        } else {
          db = new SQL.Database();
        }
      }
      ensureSchema();
    }

    function ensureSchema(){
      db.run(`CREATE TABLE IF NOT EXISTS cb (
        bond_id TEXT,
        bond_nm TEXT,
        stock_id TEXT PRIMARY KEY,
        stock_nm TEXT,
        progress_dt TEXT,
        progress_nm TEXT,
        board_dt TEXT,
        shareholder_dt TEXT,
        accept_dt TEXT,
        committee_dt TEXT,
        register_dt TEXT,
        apply_date TEXT,
        amount TEXT,
        rating_cd TEXT,
        apply_cd TEXT,
        list_date TEXT,
        maturity_dt TEXT,
        delist_dt TEXT,
        delist_notes TEXT
      );`);
      db.run(`CREATE TABLE IF NOT EXISTS meta (
        key TEXT PRIMARY KEY,
        value TEXT
      );`);
    }

    

    async function saveDB(){
      const data = db.export();
      if(hasOPFS && dbFileHandle){
        try{
          const w = await dbFileHandle.createWritable();
          await w.write(data);
          await w.close();
          return;
        }catch(e){
          hasOPFS = false;
        }
      }
      localStorage.setItem('cb_db', b64Encode(data));
    }

    function getMeta(key){
      try{
        const stmt = db.prepare('SELECT value FROM meta WHERE key = ?');
        stmt.bind([key]);
        const row = stmt.step() ? stmt.getAsObject() : null;
        stmt.free();
        return row ? row.value : null;
      }catch(e){
        return null;
      }
    }

    function setMeta(key,value){
      db.run(`INSERT INTO meta(key,value) VALUES($key,$value)
              ON CONFLICT(key) DO UPDATE SET value=$value`,{ $key:key, $value:value });
    }

    const TIME_GAP_CONFIG = {
      'shareholder_dt': { start: 'board_dt', label: '预案-批准' },
      'accept_dt': { start: 'shareholder_dt', label: '批准-受理' },
      'committee_dt': { start: 'accept_dt', label: '受理-过会' },
      'register_dt': { start: 'committee_dt', label: '过会-注册' },
      'apply_date': { start: 'register_dt', label: '注册-申购' },
      'list_date': { start: 'apply_date', label: '申购-上市' },
      'delist_dt': { start: 'list_date', label: '上市-退市' },
      'maturity_dt': { start: 'list_date', label: '上市-到期' }
    };

    function calculateAvgDays(startKey, endKey){
       let total = 0;
       let count = 0;
       const ONE_DAY = 86400000;
       if(!appState.allRows || appState.allRows.length === 0) return null;
       for(const r of appState.allRows){
         const s = r[startKey];
         const e = r[endKey];
         if(!s || !e) continue;
         const d1 = new Date(s);
         const d2 = new Date(e);
         if(isNaN(d1.getTime()) || isNaN(d2.getTime())) continue;
         const diff = d2 - d1;
         total += diff;
         count++;
       }
       if(count === 0) return null;
       return (total / count / ONE_DAY).toFixed(1);
    }

    function renderTable(){
      const thead = document.querySelector('#dataTable thead');
      const tbody = document.querySelector('#dataTable tbody');
      
      // Render Header
      const visibleCols = COLUMNS.filter(c => appState.visibleCols.includes(c.key));
      thead.innerHTML = '';
      const tr = document.createElement('tr');
      visibleCols.forEach(col => {
        const th = document.createElement('th');
        const isSorted = appState.sortCol === col.key;
        const dirClass = isSorted ? (appState.sortDir === 1 ? 'sort-asc' : 'sort-desc') : '';
        th.className = dirClass;
        


        const content = document.createElement('div');
        content.className = 'th-content';
        content.innerHTML = `<span>${col.label}</span><span class="sort-icon"><span class="up">▲</span><span class="down">▼</span></span>`;
        content.onclick = () => handleSort(col.key);
        
        const filterRow = document.createElement('div');
        filterRow.className = 'filter-row';
        const input = document.createElement('input');
        input.className = 'filter-input';
        input.placeholder = '过滤...';
        input.value = appState.filters[col.key] || '';
        input.onclick = e => e.stopPropagation(); // prevent sort
        input.oninput = e => handleFilter(col.key, e.target.value);
        
        filterRow.appendChild(input);
        th.appendChild(content);
        th.appendChild(filterRow);
        tr.appendChild(th);

        if(TIME_GAP_CONFIG[col.key]){
           const cfg = TIME_GAP_CONFIG[col.key];
           const avg = calculateAvgDays(cfg.start, col.key);
           if(avg != null){
             const info = document.createElement('div');
             info.style.fontSize = '11px';
             info.style.color = '#2563eb';
             info.style.marginBottom = '4px';
             info.style.fontWeight = 'normal';
             info.innerHTML = `${cfg.label}<br>平均: ${avg}天`;
             th.appendChild(info);
           }
        }
      });
      thead.appendChild(tr);

      // Filter and Sort Data
      let rows = [...appState.allRows];
      
      // Filter
      Object.keys(appState.filters).forEach(key => {
        const val = appState.filters[key].toLowerCase();
        if(val){
          rows = rows.filter(r => String(r[key] || '').toLowerCase().includes(val));
        }
      });
      
      // Sort
      if(appState.sortCol){
        const key = appState.sortCol;
        const dir = appState.sortDir;
        rows.sort((a,b) => {
          const va = a[key];
          const vb = b[key];
          if(va == null && vb == null) return 0;
          if(va == null) return 1;
          if(vb == null) return -1;
          
          const colDef = COLUMNS.find(c => c.key === key);
          if(colDef && colDef.type === 'number'){
            return (parseFloat(va) - parseFloat(vb)) * dir;
          }
          return String(va).localeCompare(String(vb)) * dir;
        });
      } else {
        // Default Rank Sort
        const rank = r=>{
          if(r.apply_date) return {k:5, d:r.apply_date};
          if(r.register_dt) return {k:4, d:r.register_dt};
          if(r.committee_dt) return {k:3, d:r.committee_dt};
          if(r.accept_dt) return {k:2, d:r.accept_dt};
          if(r.shareholder_dt) return {k:1, d:r.shareholder_dt};
          if(r.board_dt) return {k:0, d:r.board_dt};
          return {k:-1, d:''};
        };
        rows.sort((a,b)=>{
          const la = a.list_date ? 1 : 0;
          const lb = b.list_date ? 1 : 0;
          if(la !== lb) return la - lb;
          const ra = rank(a), rb = rank(b);
          if(rb.k !== ra.k) return rb.k - ra.k;
          if(rb.d !== ra.d) return (rb.d||'').localeCompare(ra.d||'');
          return String(b.progress_dt||'').localeCompare(String(a.progress_dt||''));
        });
      }

      // Render Body
      tbody.innerHTML = '';
      
      const totalRows = rows.length;
      const maxPage = Math.ceil(totalRows / appState.pageSize) || 1;
      if(appState.page > maxPage) appState.page = maxPage;
      if(appState.page < 1) appState.page = 1;
      
      const start = (appState.page - 1) * appState.pageSize;
      const end = Math.min(start + appState.pageSize, totalRows);
      const pageRows = rows.slice(start, end);
      
      const fragment = document.createDocumentFragment();
      for(const r of pageRows){
        const tr = document.createElement('tr');
        tr.title = '双击编辑';
        tr.style.cursor = 'pointer';
        tr.ondblclick = () => openEditDialog(r);
        for(const col of visibleCols){
          const td = document.createElement('td');
          td.textContent = r[col.key] == null ? '' : String(r[col.key]);
          tr.appendChild(td);
        }
        fragment.appendChild(tr);
      }
      tbody.appendChild(fragment);
      
      document.getElementById('rowCount').textContent = `${totalRows} 条记录`;
      
      // Update Pagination UI
      document.getElementById('pageInfo').textContent = `第 ${appState.page} / ${maxPage} 页`;
      document.getElementById('prevPageBtn').disabled = appState.page === 1;
      document.getElementById('nextPageBtn').disabled = appState.page === maxPage;
    }

    let filterDebounceTimer = null;
    function handleFilter(key, val){
      appState.filters[key] = val;
      if(filterDebounceTimer) clearTimeout(filterDebounceTimer);
      filterDebounceTimer = setTimeout(() => {
        appState.page = 1; // Reset to page 1 on filter
        renderTable();
      }, 300);
    }
    
    function loadDataFromDB(){
       const exists = db.exec(`SELECT name FROM sqlite_master WHERE type='table' AND name='cb'`);
       if(!exists.length) {
         appState.allRows = [];
         return;
       }
       const res = db.exec(`SELECT bond_id,bond_nm,stock_id,stock_nm,amount,rating_cd,progress_dt,progress_nm,board_dt,shareholder_dt,accept_dt,committee_dt,register_dt,apply_date,apply_cd,list_date,maturity_dt,delist_dt,delist_notes FROM cb`);
       if(res.length){
         appState.allRows = res[0].values.map(v=>({
            bond_id: v[0], bond_nm: v[1], stock_id: v[2], stock_nm: v[3], amount: v[4], rating_cd: v[5], progress_dt: v[6], progress_nm: v[7],
            board_dt: v[8], shareholder_dt: v[9], accept_dt: v[10], committee_dt: v[11], register_dt: v[12], apply_date: v[13], apply_cd: v[14],
            list_date: v[15], maturity_dt: v[16], delist_dt: v[17], delist_notes: v[18]
         }));
       } else {
         appState.allRows = [];
       }
    }
    
    function initSettings(){
       // Load from localStorage
       const saved = localStorage.getItem('cb_table_settings');
       if(saved){
         try{
           const parsed = JSON.parse(saved);
           if(parsed.visibleCols) appState.visibleCols = parsed.visibleCols;
         }catch(e){}
       }
       
       document.getElementById('settingsBtn').onclick = () => {
         const container = document.getElementById('colSettings');
         container.innerHTML = '';
         COLUMNS.forEach(col => {
           const label = document.createElement('label');
           label.className = 'col-option';
           const chk = document.createElement('input');
           chk.type = 'checkbox';
           chk.checked = appState.visibleCols.includes(col.key);
           chk.value = col.key;
           label.appendChild(chk);
           label.appendChild(document.createTextNode(col.label));
           container.appendChild(label);
         });
         document.getElementById('settingsDialog').showModal();
       };
       
       document.getElementById('saveSettingsBtn').onclick = () => {
         const chks = document.querySelectorAll('#colSettings input[type="checkbox"]');
         const keys = [];
         chks.forEach(c => { if(c.checked) keys.push(c.value); });
         appState.visibleCols = keys;
         localStorage.setItem('cb_table_settings', JSON.stringify({ visibleCols: keys }));
         renderTable();
         document.getElementById('settingsDialog').close();
      };
    }

    let currentEditRow = null;

    function openEditDialog(row){
      currentEditRow = row;
      const form = document.getElementById('editForm');
      form.innerHTML = '';
      
      COLUMNS.forEach(col => {
        const div = document.createElement('div');
        div.className = 'form-group';
        if(['progress_nm', 'delist_notes'].includes(col.key)){
          div.classList.add('full-width');
        }
        
        const label = document.createElement('label');
        label.textContent = col.label;
        
        const input = document.createElement('input');
        input.name = col.key;
        input.value = row[col.key] == null ? '' : row[col.key];
        // Disable PK editing for simplicity, or handle PK change carefully
        if(col.key === 'stock_id' || col.key === 'bond_id'){
           // input.disabled = true; // Let's allow editing, but warn? No, backend uses old keys.
           // Actually, if we allow editing PK, we need to handle it.
           // My backend logic uses old keys to find the row.
           // If user changes stock_id/bond_id, the UPDATE will try to set new values.
           // If new values conflict, backend might error (UNIQUE constraint).
        }
        
        div.appendChild(label);
        div.appendChild(input);
        form.appendChild(div);
      });
      
      document.getElementById('editDialog').showModal();
    }

    document.getElementById('saveEditBtn').onclick = async () => {
      if(!currentEditRow) return;
      const form = document.getElementById('editForm');
      const formData = new FormData(form);
      const newData = {};
      
      for(const [key, val] of formData.entries()){
         newData[key] = val;
      }
      
      // Send to server
      const payload = {
        old_stock_id: currentEditRow.stock_id,
        old_bond_id: currentEditRow.bond_id,
        new_data: newData
      };
      
      const btn = document.getElementById('saveEditBtn');
      btn.disabled = true;
      btn.textContent = '保存中...';
      
      try {
        const resp = await fetch('/edit_row', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const res = await resp.json();
        if(res.ok){
           // Update local data
           Object.assign(currentEditRow, newData);
           renderTable();
           document.getElementById('editDialog').close();
        } else {
           alert('保存失败: ' + (res.error || '未知错误'));
        }
      } catch(e){
        alert('保存失败: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = '保存';
      }
    };

    async function loadDbFromServer(){
      try{
        const resp = await fetch(`${SERVER_DB_PATH}?t=${Date.now()}`, { method:'GET', cache:'no-store' });
        if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const buf = await resp.arrayBuffer();
        if(buf.byteLength>0){
          db = new SQL.Database(new Uint8Array(buf));
          loadDataFromDB();
          renderTable();
        } else {
          setStatus('尚未生成数据库');
        }
      }catch(e){
        setStatus('读取数据库失败');
      }
    }

    async function updateData(){
      const btn = document.getElementById('updateBtn');
      btn.disabled = true;
      setStatus('更新中…');
      try{
        const resp = await fetch(SERVER_UPDATE_URL, { method:'GET' });
        if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
        await loadDbFromServer();
        setStatus('更新完成');
        refreshLastUpdate();
      }catch(e){
        setStatus('更新失败');
      } finally {
        btn.disabled = false;
      }
    }

    function refreshLastUpdate(){
      const lv = getMeta('last_update');
      document.getElementById('lastUpdate').textContent = `最后更新：${lv?lv:'—'}`;
    }

    function setStatus(s){
      const el = document.getElementById('status');
      el.textContent = s;
      el.className = s.includes('失败')? 'status-warn' : 'status-ok';
    }

    async function exportDb(){
      const bytes = db.export();
      const blob = new Blob([bytes], { type:'application/octet-stream' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = DB_FILE;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    function exportExcel(){
      if(typeof XLSX === 'undefined'){
        exportCSV();
        return;
      }
      const exists = db.exec(`SELECT name FROM sqlite_master WHERE type='table' AND name='cb'`);
      if(!exists.length){
        return;
      }
      const res = db.exec(`SELECT bond_id,bond_nm,stock_id,stock_nm,amount,rating_cd,progress_dt,progress_nm,board_dt,shareholder_dt,accept_dt,committee_dt,register_dt,apply_date,apply_cd,list_date,maturity_dt,delist_dt,delist_notes FROM cb`);
      const header = ['可转债代码','可转债名称','股票代码','股票名称','发行规模（亿元）','信用评级','当前方案进展时间','当前方案进展','董事会预案时间','股东大会批准时间','交易所受理时间','上市委通过时间','同意注册时间','申购时间','申购代码','上市日期','到期日期','退市日期','退市原因'];
      const aoa = [header];
      const rows = res.length ? res[0].values : [];
      for(const r of rows){
        aoa.push(r.map(v=> v==null? '' : String(v)));
      }
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '数据');
      XLSX.writeFile(wb, 'cb_data.xlsx');
    }

    function exportCSV(){
      const exists = db.exec(`SELECT name FROM sqlite_master WHERE type='table' AND name='cb'`);
      if(!exists.length){
        return;
      }
      const res = db.exec(`SELECT bond_id,bond_nm,stock_id,stock_nm,amount,rating_cd,progress_dt,progress_nm,board_dt,shareholder_dt,accept_dt,committee_dt,register_dt,apply_date,apply_cd,list_date,maturity_dt,delist_dt,delist_notes FROM cb`);
      const header = ['可转债代码','可转债名称','股票代码','股票名称','发行规模（亿元）','信用评级','当前方案进展时间','当前方案进展','董事会预案时间','股东大会批准时间','交易所受理时间','上市委通过时间','同意注册时间','申购时间','申购代码','上市日期','到期日期','退市日期','退市原因'];
      const lines = [];
      lines.push(header.join(','));
      const rows = res.length ? res[0].values : [];
      for(const r of rows){
        const cols = r.map(v=>{
          const s = v==null? '' : String(v);
          const needQuote = /[",\n]/.test(s);
          const escaped = s.replace(/"/g,'""');
          return needQuote ? '"'+escaped+'"' : escaped;
        });
        lines.push(cols.join(','));
      }
      const blob = new Blob(["\ufeff" + lines.join('\n')], { type:'text/csv;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'cb_data.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    

    function scheduleDaily(){
      const enabled = localStorage.getItem('auto_daily') === '1';
      document.getElementById('autoToggle').checked = enabled;
      if(!enabled) return;
      const last = getMeta('last_update');
      if(last !== todayStr()) updateData();
      const now = new Date();
      const next = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 8, 30, 0);
      const ms = next - now;
      setTimeout(()=>{ updateData(); scheduleDaily(); }, ms);
    }

    function bindUI(){
      document.getElementById('updateBtn').addEventListener('click', updateData);
      document.getElementById('exportBtn').addEventListener('click', exportDb);
      document.getElementById('exportExcelBtn').addEventListener('click', exportExcel);
      document.getElementById('autoToggle').addEventListener('change', e=>{
        localStorage.setItem('auto_daily', e.target.checked? '1':'0');
        scheduleDaily();
      });
      
      document.getElementById('prevPageBtn').onclick = () => {
        if(appState.page > 1) {
           appState.page--;
           renderTable();
        }
      };
      document.getElementById('nextPageBtn').onclick = () => {
         // maxPage logic is inside renderTable, but we can trust the button state or calc here.
         // Let's just increment and renderTable will clamp it.
         appState.page++;
         renderTable();
      };
      document.getElementById('pageSizeSelect').onchange = (e) => {
         appState.pageSize = parseInt(e.target.value);
         appState.page = 1;
         renderTable();
      };
    }

    (async function(){
      await initSQL();
      initSettings();
      await loadDbFromServer();
      await updateData();
      bindUI();
      refreshLastUpdate();
      setStatus('已加载');
    })();
  </script>
</body>
</html>
